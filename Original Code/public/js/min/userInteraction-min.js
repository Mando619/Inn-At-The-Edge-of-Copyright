const DIRECTIONWORDS={N:["n","north"],E:["e","east"],S:["s","south"],W:["w","west"]},ARTICLES=["the","a","an"],MULTIPLES=["set","pair","box","bag"],VOWELS=["a","e","i","o","u"];let currentLocation,currentExits,currentLocationId,currentLocationInventory,currentUserData,currentUserId,locationIndex,locationOccupants,sleepInterval,userRecentCommandsIndex,isDay=!0,actionData={},actionCalls={},position="standing",sleeping=!1,userRecentCommands=[];function doesThisStartWithThose(t,e){for(let n of e){if(t.toLowerCase().startsWith(n)&&n.length>1)return!0;if(t.split(" ")[0].toLowerCase()===n.toLowerCase())return!0}return!1}function startsWithOrIs(t,e){return!!(e.toLowerCase().startsWith(`${t} `)||e.toLowerCase().startsWith(t)&&e.length===t.length)}function takeTheseOffThat(t,e){for(let n of t)if(e.toLowerCase().startsWith(n))return e.slice(n.length).trim();return e}function doesThisEqualThat(t,e){for(let n of e)if(t.toLowerCase().trim()===n)return!0;return!1}function parseAlternateWords(t,e){for(let n in e)if(t.toLowerCase().trim()===e[n])return n;return t}function logThis(t){$("#anchor").before(`<p class="displayed-message">${t}</p>`),updateScroll()}function describeThis(t){$("#anchor").before(`<p class="displayed-description">${t}</p>`),updateScroll()}function listThis(t){$("#anchor").before(`<p class="displayed-stat">${t}</p>`)}function updateScroll(){$(".message-output-box").scrollTop($(".message-output-box")[0].scrollHeight)}function pluralizeAppropriateWords(t,e){return doesThisStartWithThose(t,MULTIPLES)?t:pluralize(t,e)}function insertArticleSingleValue(t){return doesThisStartWithThose(t,VOWELS)?`an ${t}`:`a ${t}`}function findItemSlot(t){return new Promise(function(e,n){for(const n in t)n.endsWith("Slot")&&!0===t[n]&&e(n)})}function findMatchByItemName(t,e){return new Promise(function(n,o){for(const o of e)o.item.itemName.toLowerCase()===t.toLowerCase()&&n(o);n(!1)}).catch(t=>{console.log("Error:"),console.log(t.message)})}function findMatchByCharacterName(t){return new Promise(function(e,n){let o=currentLocation.NPCs.split(", ");for(const n of o)t===n&&e();n()})}function findMatchByItemIdInObject(t,e){return new Promise(function(n,o){for(const o in e)e[o]===t&&n(t);n(!1)})}function findMatchByItemNameAndChangeQuantity(t,e,n,o){return new Promise(function(i,a){let s;for(const a of e)a.item.itemName.toLowerCase()===t.toLowerCase()&&(changeItemQuantity(a.itemId,n,o),scrubInventory(),s=!0,i(!0));i(!1)})}function setUserInventoryId(){return new Promise(function(t,e){getPlayerData(thisUser).then(function(e){thisUser=pubnub.getUUID(),currentUserData=e,currentUserId="P"+e.id,t(currentUserData)})})}function setActionCalls(){getActions().then(function(t){actionData=t;for(const e of t)actionCalls[e.actionName]=e.waysToCall.split(", ")})}function compileExits(t){let e={};for(const n in t)n.startsWith("exit")&&(e[n.replace("exit","")]=t[n]);return e}function printExits(t){let e="";for(const n in t)null!=t[n]&&(e+=n+", ");e.length>0?describeThis(`Exits: ${e}`):describeThis("No visible exits.")}function printLocationDescription(t){describeThis(isDay?t.dayDescription:t.nightDescription)}function parseWhosOnline(){let t="",e=[];whosOnline().then(n=>{locationOccupants=n;let o=Object.keys(n.channels)[0];if(void 0!==n.channels[o]&&n.channels[o].occupants.length>0){for(const t of n.channels[o].occupants)e.push(t.uuid);t+=e.join(", "),$("#location-info").html(`<p class="displayed-description">In ${currentLocation.locationName}: ${t}</p>`)}})}function parseMove(t){if("standing"===position){t=takeTheseOffThat(actionCalls.move,t);let e=!1;for(const n in DIRECTIONWORDS)DIRECTIONWORDS[n].includes(t.toLowerCase())&&(e=!0,newLocation(n));e||(logThis(`You can't move '${t}'! For help, type 'help move'.`),updateScroll())}else logThis("You'll need to stand up for that!")}function parseInventory(t){return new Promise(function(e,n){scrubInventory(),"player"===t.toLowerCase()?getInventory(currentUserId).then(function(t){let n=[];for(const e of t)n.push(`${e.quantity} ${pluralizeAppropriateWords(e.item.itemName,e.quantity)}`);logThis(`Your inventory: <br> ${n.join("<br>")}`),e(n)}):"location"===t.toLowerCase()?getInventory(currentLocationId).then(function(t){currentLocationInventory=[];let n=[];for(const e of t)n.push(`${e.quantity} ${pluralizeAppropriateWords(e.item.itemName,e.quantity)}`);(currentLocationInventory=n).length>0?(describeThis(`You see: ${currentLocationInventory.join(", ")}`),e(currentLocationInventory)):e(!1)}):t.startsWith("I")&&getInventory(t).then(function(t){let n=[];for(const e of t)n.push(`${e.quantity} ${pluralizeAppropriateWords(e.item.itemName,e.quantity)}`);e(n)})})}function speak(t){if(t.toLowerCase().startsWith("speak to")||t.toLowerCase().startsWith("talk to")||t.toLowerCase().startsWith("say to")){let e=(t=takeTheseOffThat(["speak to ","talk to ","say to "],t.trim())).split(" ")[0],n=t.split(" ").slice(1).join(" ");findMatchByCharacterName(e=e[0].toUpperCase()+e.slice(1)).then(()=>{runNPC(e,n,logThis,describeThis,listThis)}).catch(t=>{console.log(t),logThis("You cannot speak directly to "+e)})}else t=takeTheseOffThat(actionCalls.speak,t),publishMessage(t),updateScroll()}function talkDirectlyToNPC(t){let e=t.split(" ")[0];e=e.replace(",","");let n=t.split(" ").slice(1).join(" ");findMatchByCharacterName(e=e[0].toUpperCase()+e.slice(1)).then(()=>{runNPC(e,n,logThis,describeThis,listThis)}).catch(t=>{console.log(t),logThis("You cannot speak directly to "+e)})}function displayHelp(t){if("help"===t.toLowerCase()){let t="           HELP        ",e="---------------------";for(action of(listThis(t),listThis(e),actionData))listThis(`${action.actionName}      --${action.commandBriefDescription}`),updateScroll();logThis(" "),updateScroll()}else{for(action of actionData)if(console.log(action.actionName),t.split(" ")[1].toLowerCase()==action.actionName){listThis(action.actionName.toUpperCase()),listThis(" "),listThis(action.commandLongDescription),listThis(" "),listThis(`example: ${action.exampleCall}      --result: ${action.exampleResult}`),listThis(" "),updateScroll();break}logThis(" "),updateScroll()}}function lookAround(t){scrubInventory(),logThis("You look around."),printLocationDescription(currentLocation),printExits(currentExits),parseInventory("Location")}function getItem(t){let e;t=takeTheseOffThat(actionCalls.get,t),t=takeTheseOffThat(ARTICLES,t),findItemData(t).then(t=>e=t.id),getInventory(currentLocationId).then(function(n){findMatchByItemNameAndChangeQuantity(t,n,currentLocationId,-1).then(function(n){n?getInventory(currentUserId).then(function(n){findMatchByItemNameAndChangeQuantity(t,n,currentUserId,1).then(function(n){if(logThis(`You pick up ${insertArticleSingleValue(t)}.`),!n)return addItemToInventory(e,currentUserId,1),"added item to Inventory"})}):logThis(`There's no ${t} here!`)})})}function dropItem(t){let e;t=takeTheseOffThat(actionCalls.drop,t),t=takeTheseOffThat(ARTICLES,t),findItemData(t).then(t=>e=t.id),getInventory(currentUserId).then(function(n){findMatchByItemNameAndChangeQuantity(t,n,currentUserId,-1).then(function(n){n?getInventory(currentLocationId).then(function(n){findMatchByItemNameAndChangeQuantity(t,n,currentLocationId,1).then(function(n){logThis(`You drop ${insertArticleSingleValue(t)}.`),n||addItemToInventory(e,currentLocationId,1)})}):logThis(`You don't have any ${pluralize(t,4)} to drop!`)})})}function wearItem(t){t=takeTheseOffThat(actionCalls.wear,t),t=takeTheseOffThat(ARTICLES,t),getInventory(currentUserId).then(function(e){findMatchByItemName(t,e).then(function(e){if(e){let e;findItemData(t).then(function(n){e=n.id,findItemSlot(n).then(function(n){changeIsEquipped(e,currentUserId,1).then(function(o){fillPlayerInvSlot(e,parseInt(currentUserId.slice(1,currentUserId.length)),n).then(function(e){logThis(`You put on ${insertArticleSingleValue(t)}.`)})})})})}else logThis(`You don't have any ${pluralize(t,4)} to wear!`)})})}function removeItem(t){t=takeTheseOffThat(actionCalls.remove,t),t=takeTheseOffThat(ARTICLES,t),locateEquippedItems(currentUserData.id).then(function(e){let n;findItemData(t).then(function(o){null!=o?findMatchByItemIdInObject(n=o.id,e).then(function(e){e?findItemSlot(o).then(e=>{changeIsEquipped(n,currentUserId,-1).then(n=>{fillPlayerInvSlot(null,currentUserData.id,e).then(e=>{logThis(`You take off ${insertArticleSingleValue(t)}.`)})})}):logThis(`You don't have ${insertArticleSingleValue(t)} to take off!`)}):logThis("hmmm... not sure what a "+t+" is.")})})}function emote(t){t=takeTheseOffThat(actionCalls.emote,t),publishDescription(t)}function parseStats(){getStats(currentUserData.characterName).then(t=>{let e="---------------------";$("#anchor").before('<p class="displayed-stat">           STATS        </p>'),$("#anchor").before(`<p class="displayed-stat">${e}</p>`);let n=t.maxHP;delete t.maxHP;for(const e in t){let o="    ";3===e.length?(o+=` ${e}   |  `,statValue=parseInt(t[e]),$("#anchor").before(`<p class="displayed-stat">${o}<span id="blue">${statValue}</span></p>`)):2==e.length?(o+=` ${e.toUpperCase()}     |  `,"HP"===e&&t.HP<n?(statValue=parseInt(t[e]),$("#anchor").before(`<p class="displayed-stat">${o}<span id="red">${statValue}</span>/${n}</p>`)):"HP"===e&&t.HP>=n?(statValue=parseInt(t[e]),$("#anchor").before(`<p class="displayed-stat">${o}<span id="green">${statValue}</span>/${n}</p>`)):(statValue=parseInt(t[e]),$("#anchor").before(`<p class="displayed-stat">${o}<span id="levels">${statValue}</span></p>`))):(o+=`${e}   |  `,statValue=parseInt(t[e]),$("#anchor").before(`<p class="displayed-stat">${o}<span id="levels">${statValue}</span></p>`))}$("#anchor").before(`<p class="displayed-stat">${e}</p>`),updateScroll()})}function sleep(){if("laying"===position)if(sleeping)logThis("... you're already asleep.");else{logThis("You fall into a deep slumber"),sleeping=!0,pubnub.unsubscribeAll(),publishDescription("falls asleep.");let t=0;sleepInterval=setInterval(function(){getStats(currentUserData.characterName).then(e=>{t>1&&e.HP<e.maxHP&&incrementStat("HP",1,currentUserData.characterName),t++})},5e3)}else logThis("You'll need to lie down for that!")}function wake(){if(sleeping){publishDescription("opens their eyes"),sleeping=!1,clearInterval(sleepInterval);const t=currentLocation.locationName.replace(/ /g,"-");channel="oo-chat-"+t,console.log("In Room ID: "+t),pubnub.subscribe({channels:[channel]}),logThis("You wake up.")}else logThis("You can't wake up if you're not asleep.")}function sitStandLie(t){"stand"==t||"stand up"==t?"standing"!==position?(position="standing",publishDescription("stands up.")):logThis("You're already standing!"):"sit"==t||"sit down"==t?"sitting"!==position?(position="sitting",publishDescription("sits down.")):logThis("You're already sitting!"):"lay"!=t&&"lay down"!=t&&"lie"!=t&&"lie down"!=t||("laying"!==position?(position="laying",publishDescription("lies down.")):logThis("You're already lying down!"))}function giveItem(t){let e,n;t=takeTheseOffThat(actionCalls.give,t),t=takeTheseOffThat(ARTICLES,t),console.log("In Give:"),console.log(t),function(t){return new Promise(function(o,i){2==t.split(" to ").length?(e=t.split(" to ")[1],n=t.split(" to ")[0],o()):(n=t.split(" to ")[0],e=t.slice(n.length+3),o())}).catch(t=>{console.log(t.message)})}(t).then(function(){console.log(e),console.log(n),getInventory(currentUserId).then(o=>{findMatchByItemNameAndChangeQuantity(n,o,currentUserId,-1).then(o=>{o?getPlayerData(e).then(t=>{let o="P"+t.id;getInventory(o).then(t=>{findMatchByItemNameAndChangeQuantity(n,t,o,1).then(t=>{t?publishDescription(`gives ${insertArticleSingleValue(n)} to ${e}.`):findItemData(n).then(t=>{addItemToInventory(t.id,o,1),publishDescription(`gives ${insertArticleSingleValue(n)} to ${e}.`)})})})}):logThis(`You don't seem to have ${insertArticleSingleValue(t)} to give...`)})})})}function examine(t){t=takeTheseOffThat(actionCalls.examine,t),(t=takeTheseOffThat(ARTICLES,t)).toLowerCase().startsWith("self")&&(logThis(currentUserData.description),parseStats(),locateEquippedItems(currentUserData.id).then(t=>{console.log(t)})),findItemData(t).then(e=>{null==e||getInventory(currentUserId).then(n=>{findMatchByItemName(t,n).then(n=>{n?(logThis(`You look closely at ${insertArticleSingleValue(t)}.`),logThis(`You see ${e.description}.`)):getInventory(currentLocationId).then(n=>{findMatchByItemName(t,n).then(n=>{n?(logThis(`You look closely at ${insertArticleSingleValue(t)}.`),logThis(`You see ${e.description}.`)):logThis(`There doesn't seem to be ${insertArticleSingleValue(t)} here.`)})})})})})}function findNewLocationData(t){return new Promise(function(e,n){"start"==t?getLocation(currentUserData.lastLocation).then(function(t){currentLocation=t,currentLocationId="L"+t.id,locationIndex=t.locationName.replace(/ /g,"-"),$("#location-info").html(`<p class="displayed-description">In ${currentLocation.locationName}</p>`),$("#anchor").before(`<p class="displayed-message" style="color:rgb(249, 255, 199)">${currentLocation.locationName}</p>`),printLocationDescription(currentLocation),printExits(currentExits=compileExits(currentLocation)),1002==t.id&&getInventory(currentUserId).then(function(t){findMatchByItemName("dull ring",t).then(t=>{console.log("looking in your bags"),t||(console.log("it's a desolate place have a ring"),addItemToInventory(131,currentUserId,1))})}),setTimeout(parseWhosOnline(),4e3),updateScroll(),e()}):null!=currentExits[t]?getLocation(currentExits[t]).then(function(t){currentLocationInventory=[],currentExits=compileExits(currentLocation=t),currentLocationId="L"+t.id,locationIndex=t.locationName.replace(/ /g,"-"),rememberLocation(currentUserData.characterName,currentLocation.id),$("#location-info").html(`<p class="displayed-description">In ${currentLocation.locationName}</p>`),$("#anchor").before(`<p class="displayed-message" style="color:rgb(249, 255, 199)">${currentLocation.locationName}</p>`),printLocationDescription(currentLocation),printExits(currentExits),setTimeout(parseWhosOnline(),4e3),updateScroll(),e()}):(logThis("There's no exit at "+t),e())})}const newLocation=function(t){findNewLocationData(t).then(function(){channel="oo-chat-"+locationIndex,console.log("In Room ID: "+locationIndex);pubnub.unsubscribeAll(),console.log("subscribing"),pubnub.subscribe({channels:[channel],withPresence:!0})})};$("#submit-button").click(function(t){t.preventDefault();let e=$(".chat-input").val();$(".chat-input").val(""),userRecentCommands.push(e),doesThisStartWithThose(e,actionCalls.move)?parseMove(e):"stop juggling"===e.toLowerCase()?stopJuggling():doesThisStartWithThose(e,actionCalls.inventory)?parseInventory("Player"):doesThisStartWithThose(e,actionCalls.speak)?speak(e):doesThisStartWithThose(e,currentLocation.NPCs.split(", "))?talkDirectlyToNPC(e):doesThisStartWithThose(e,actionCalls.help)?displayHelp(e):doesThisStartWithThose(e,actionCalls.look)?lookAround(e):juggleTime?logThis("You should probably stop juggling first."):doesThisStartWithThose(e,actionCalls.get)?getItem(e):doesThisStartWithThose(e,actionCalls.drop)?dropItem(e):doesThisStartWithThose(e,actionCalls.wear)?wearItem(e):doesThisStartWithThose(e,actionCalls.remove)?removeItem(e):doesThisStartWithThose(e,actionCalls.emote)?emote(e):doesThisStartWithThose(e,actionCalls.juggle)?juggle(e):doesThisStartWithThose(e,actionCalls.stats)?parseStats():doesThisStartWithThose(e,actionCalls.sleep)?sleep():doesThisStartWithThose(e,actionCalls.wake)?wake():doesThisStartWithThose(e,actionCalls.position)?sitStandLie(e):doesThisStartWithThose(e,actionCalls.give)?giveItem(e):doesThisStartWithThose(e,actionCalls.examine)?examine(e):logThis("hmmm... that didn't quite make sense. Try 'help' for a list of commands!")}),$(".chat-input").keydown(function(t){38==t.which?(userRecentCommandsIndex-=1,$(".chat-input").val(userRecentCommands[userRecentCommandsIndex])):40==t.which?(userRecentCommandsIndex+=1,$(".chat-input").val(userRecentCommands[userRecentCommandsIndex])):13==t.which&&(userRecentCommandsIndex=userRecentCommands.length+1)}),setActionCalls();